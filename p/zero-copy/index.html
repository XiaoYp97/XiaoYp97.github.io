<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="\u200b零拷贝（Zero-Copy）是一种操作系统级别的 I/O 优化技术，旨在减少或避免数据在内存中的多次拷贝，降低 CPU 占用率，提高数据传输效率，尤其适用于高并发、大吞吐量的场景，如网络通信、文件传输等。"><title>零拷贝</title><link rel=canonical href=https://blog.yellster.top/p/zero-copy/><link rel=stylesheet href=/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css><meta property='og:title' content="零拷贝"><meta property='og:description' content="\u200b零拷贝（Zero-Copy）是一种操作系统级别的 I/O 优化技术，旨在减少或避免数据在内存中的多次拷贝，降低 CPU 占用率，提高数据传输效率，尤其适用于高并发、大吞吐量的场景，如网络通信、文件传输等。"><meta property='og:url' content='https://blog.yellster.top/p/zero-copy/'><meta property='og:site_name' content='Yellster - Blog'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='I/O'><meta property='article:tag' content='随记'><meta property='article:tag' content='操作系统'><meta property='article:tag' content='Linux'><meta property='article:tag' content='零拷贝'><meta property='article:tag' content='用户空间'><meta property='article:tag' content='内核空间'><meta property='article:tag' content='微内核'><meta property='article:tag' content='宏内核'><meta property='article:published_time' content='2024-09-21T16:09:09+08:00'><meta property='article:modified_time' content='2024-09-21T16:09:09+08:00'><meta property='og:image' content='https://blog.yellster.top/p/zero-copy/zero-copy.png'><meta name=twitter:title content="零拷贝"><meta name=twitter:description content="\u200b零拷贝（Zero-Copy）是一种操作系统级别的 I/O 优化技术，旨在减少或避免数据在内存中的多次拷贝，降低 CPU 占用率，提高数据传输效率，尤其适用于高并发、大吞吐量的场景，如网络通信、文件传输等。"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://blog.yellster.top/p/zero-copy/zero-copy.png'><link rel="shortcut icon" href=https://avatars.githubusercontent.com/u/37898221></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src="https://avatars.githubusercontent.com/u/37898221?v=4" width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🇨🇳</span></figure><div class=site-meta><h1 class=site-name><a href=/>Yellster - Blog</a></h1><h2 class=site-description>想都是问题，做才是答案</h2></div></header><ol class=menu-social><li><a href=https://github.com/Yellster target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>首页</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>链接</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#传统-io-的调用>传统 I/O 的调用</a></li><li><a href=#零拷贝>零拷贝</a></li><li><a href=#零拷贝的实现方式>零拷贝的实现方式</a><ol><li><a href=#mmap--write>mmap + write</a></li><li><a href=#sendfile>sendfile</a></li><li><a href=#sendfile--sg-dma>sendfile + SG-DMA</a></li><li><a href=#对比>对比</a></li></ol></li><li><a href=#扩展>扩展</a><ol><li><a href=#内核空间和用户空间>内核空间和用户空间</a><ol><li><a href=#地址空间划分以-32-位系统4gb-为例><strong>地址空间划分（以 32 位系统、4GB 为例）：</strong></a></li><li><a href=#隔离性><strong>隔离性</strong></a></li></ol></li><li><a href=#内核态和用户态>内核态和用户态</a><ol><li><a href=#如何切换><strong>如何切换？</strong></a></li></ol></li><li><a href=#微内核和宏内核>微内核和宏内核</a></li><li><a href=#上下文切换>上下文切换</a></li><li><a href=#dma>DMA</a></li></ol></li></ol></nav></div></section></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/zero-copy/><img src=/p/zero-copy/zero-copy_hu_1e496f0264c11ad.png srcset="/p/zero-copy/zero-copy_hu_1e496f0264c11ad.png 800w, /p/zero-copy/zero-copy_hu_80c811c00bd9da53.png 1600w" width=800 height=547 loading=lazy alt="Featured image of post 零拷贝"></a></div><div class=article-details><header class=article-category><a href=/categories/i/o/>I/O
</a><a href=/categories/%E9%9A%8F%E8%AE%B0/>随记
</a><a href=/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统
</a><a href=/categories/linux/>Linux</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/zero-copy/>零拷贝</a></h2><h3 class=article-subtitle>​零拷贝（Zero-Copy）是一种操作系统级别的 I/O 优化技术，旨在减少或避免数据在内存中的多次拷贝，降低 CPU 占用率，提高数据传输效率，尤其适用于高并发、大吞吐量的场景，如网络通信、文件传输等。</h3></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>2024-09-21</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 2 分钟</time></div></footer></div></header><section class=article-content><p><strong>​零拷贝（Zero-Copy）</strong> 是一种操作系统级别的 I/O 优化技术，旨在减少或避免数据在内存中的多次拷贝，降低 CPU 占用率，提高数据传输效率，尤其适用于高并发、大吞吐量的场景，如网络通信、文件传输等。</p><h2 id=传统-io-的调用>传统 I/O 的调用</h2><p>传统 I/O 操作中，数据需要从磁盘文件拷贝到内核空间，再从内核空间拷贝到用户空间，然后再拷贝到 <code>Socket Buffer</code> 中，再拷贝到网卡设备。</p><p><img src=/p/zero-copy/%E4%BC%A0%E7%BB%9F%E6%8B%B7%E8%B4%9D.png width=1080 height=607 srcset="/p/zero-copy/%E4%BC%A0%E7%BB%9F%E6%8B%B7%E8%B4%9D_hu_f7b29adf1e79d7de.png 480w, /p/zero-copy/%E4%BC%A0%E7%BB%9F%E6%8B%B7%E8%B4%9D_hu_d56501e2b550c485.png 1024w" loading=lazy alt=传统拷贝 class=gallery-image data-flex-grow=177 data-flex-basis=427px></p><p>传统的 I/O 操作过程中，涉及到 <strong>4 次上下文切换</strong>（用户态和内核态的上下文切换）和 <strong>4 次数据拷贝</strong>（2 次 CPU 拷贝、2 次 DMA 拷贝）：</p><ol><li><strong>上下文从用户态切换到内核态</strong>：应用程序进程调用 <code>read</code> ，发起 <code>I/O 调用</code>；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 将数据从 <code>磁盘文件（硬件设备）</code> 拷贝到 <code>内核缓冲区（内核空间）</code>；</li><li><strong>上下文从内核态切换到用户态</strong>：<code>read</code> 调用返回；</li><li><strong>CPU 拷贝</strong>：<code>CPU</code> 将数据从 <code>内核缓冲区（内核空间）</code> 拷贝到 <code>用户缓冲区（用户空间）</code>；</li><li><strong>上下文从用户态切换到内核态</strong>：应用程序进程调用 <code>write</code> ，发起 <code>I/O 调用</code>；</li><li><strong>CPU 拷贝</strong>：<code>CPU</code> 将数据从 <code>用户缓冲区（用户空间）</code> 拷贝到 <code>Socket Buffer（内核空间）</code>；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 将数据从 <code>Socket Buffer（内核空间）</code> 拷贝到 <code>网卡设备（硬件设备）</code>；</li><li><strong>上下文从内核态切换到用户态</strong>：<code>wirte</code> 调用返回。</li></ol><h2 id=零拷贝>零拷贝</h2><p>相比 传统 I/O 调用，零拷贝通过直接拷贝数据，避免了多次拷贝操作。</p><blockquote><p><strong>零拷贝并不是没有拷贝数据，而是减少用户态/内核态的切换次数以及CPU拷贝的次数</strong>。</p></blockquote><h2 id=零拷贝的实现方式>零拷贝的实现方式</h2><h3 id=mmap--write>mmap + write</h3><ol><li><strong>上下文从用户态切换到内核态</strong>：应用程序进程发起 <code>mmap</code> 调用；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 将数据从 <code>磁盘文件（硬件设备）</code> 拷贝到 <code>内核缓冲区（内核空间）</code>；</li><li><strong>上下文从内核态切换到用户态</strong>：<code>内核缓冲区（内核空间）</code> 地址和 <code>用户缓冲区（用户空间）</code>地址映射，内核缓冲区和应用缓冲区共享，<code>mmap</code> 调用返回；</li><li><strong>上下文从用户态切换到内核态</strong>：应用程序进程调用 <code>write</code> ，发起 <code>I/O 调用</code>；</li><li><strong>CPU 拷贝</strong>：<code>CPU</code> 将数据从 <code>用户缓冲区（用户空间）</code> 拷贝到 <code>Socket Buffer（内核空间）</code>；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 根据 <strong>文件描述符信息</strong> 直接把数据从 <code>内核缓冲区（内核空间）</code> 拷贝到 <code>网卡设备（硬件设备）</code>；</li><li><strong>上下文从内核态切换到用户态</strong>：<code>write</code> 调用返回。</li></ol><p><img src=/p/zero-copy/mmap.png width=2140 height=1274 srcset="/p/zero-copy/mmap_hu_5a941f8777696c89.png 480w, /p/zero-copy/mmap_hu_34d26fd28530ab6.png 1024w" loading=lazy alt="mmap + write" class=gallery-image data-flex-grow=167 data-flex-basis=403px></p><p>mmap + write 调用涉及到 <strong>4 次上下文切换</strong> 和 <strong>3 次数据拷贝</strong>（1 次 CPU 拷贝、2 次 DMA 拷贝）。</p><blockquote><p><code>mmap</code> 是将读缓冲区的地址和用户缓冲区的地址进行映射，内核缓冲区和应用缓冲区共享，所以节省了一次CPU拷贝，并且用户进程内存是<strong>虚拟的</strong>，只是<strong>映射到内核的读缓冲区</strong>，可以节省一半的内存空间。</p></blockquote><h3 id=sendfile>sendfile</h3><p>sendfile表示在两个文件描述符之间传输数据，它是在 <strong>操作系统内核</strong> 中操作的，<strong>避免了数据从内核缓冲区和用户缓冲区之间的拷贝操作</strong>，因此可以使用它来实现零拷贝。</p><ol><li><strong>上下文从用户态切换到内核态</strong>：应用程序进程发起 <code>sendfile</code> 调用；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 将数据从 <code>磁盘文件（硬件设备）</code> 拷贝到 <code>内核缓冲区（内核空间）</code>；</li><li><strong>CPU 拷贝</strong>：<code>CPU</code> 将数据从 <code>内核缓冲区（内核空间）</code> 拷贝到 <code>Socket Buffer（内核空间）</code>；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 将数据从 <code>Socket Buffer（内核空间）</code> 拷贝到 <code>网卡设备（硬件设备）</code>；</li><li><strong>上下文从内核态切换到用户态</strong>：<code>sendfile</code> 调用返回。</li></ol><p><img src=/p/zero-copy/sendfile.png width=1080 height=602 srcset="/p/zero-copy/sendfile_hu_e7b239b45142fd65.png 480w, /p/zero-copy/sendfile_hu_9c62413f8190d489.png 1024w" loading=lazy alt=sendfile class=gallery-image data-flex-grow=179 data-flex-basis=430px></p><p>相比传统 I/O 调用，<code>sendfile</code> 调用涉及到 <strong>2 次上下文切换</strong> 和 <strong>3 次数据拷贝</strong>（1 次 CPU 拷贝、2 次 DMA 拷贝）。</p><h3 id=sendfile--sg-dma>sendfile + SG-DMA</h3><blockquote><p>Linux 2.4+版本提出。</p></blockquote><ol><li><strong>上下文从用户态切换到内核态</strong>：应用程序进程发起 <code>sendfile</code> 调用；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 将数据从 <code>磁盘文件（硬件设备）</code> 拷贝到 <code>内核缓冲区（内核空间）</code>；</li><li><strong>只拷贝文件描述符信息</strong>：<code>CPU</code> 将 <code>内核缓冲区（内核空间）</code> 中的 <strong>文件描述符信息</strong>（包括内核缓冲区的内存地址和偏移量） 拷贝到 <code>Socket Buffer（内核空间）</code>；</li><li><strong>DMA 拷贝</strong>：<code>DMA 控制器</code> 根据 <strong>文件描述符信息</strong> 直接把数据从 <code>内核缓冲区（内核空间）</code> 拷贝到 <code>网卡设备（硬件设备）</code>；</li><li><strong>上下文从内核态切换到用户态</strong>：<code>sendfile</code> 调用返回。</li></ol><p><img src=/p/zero-copy/sendfile+SG-DMA.png width=1080 height=606 srcset="/p/zero-copy/sendfile+SG-DMA_hu_7557d5dfc97a5e05.png 480w, /p/zero-copy/sendfile+SG-DMA_hu_3efc44873afcaced.png 1024w" loading=lazy alt="sendfile + SG-DMA" class=gallery-image data-flex-grow=178 data-flex-basis=427px></p><p>相比单独的 sendfile，<code>sendfile + SG-DMA</code> 调用涉及到 <strong>2 次上下文切换</strong> 和 <strong>2 次数据拷贝</strong>（2 次 DMA 拷贝）。</p><blockquote><p>真正实现了 零拷贝，全程都没有通过CPU来搬运数据，所有的数据都是通过DMA来进行传输的。</p></blockquote><h3 id=对比>对比</h3><div class=table-wrapper><table><thead><tr><th>方法</th><th>上下文切换</th><th>拷贝次数</th><th>CPU参与</th><th>适用场景</th></tr></thead><tbody><tr><td>传统I/O</td><td>4次</td><td>4次</td><td>2次</td><td>通用场景（性能较低）</td></tr><tr><td>mmap + write</td><td>4次</td><td>3次</td><td>1次</td><td>需用户态处理数据的场景</td></tr><tr><td>sendfile</td><td>2次</td><td>3次</td><td>1次</td><td>文件到网络的高性能传输</td></tr><tr><td>sendfile + SG-DMA</td><td>2次</td><td>2次</td><td>0次</td><td>文件到网络的高性能传输</td></tr></tbody></table></div><h2 id=扩展>扩展</h2><h3 id=内核空间和用户空间>内核空间和用户空间</h3><ul><li><strong>内核空间</strong>：操作系统内核运行的内存区域，具有最高权限，可以直接访问硬件、内存管理、文件系统等底层资源。</li><li><strong>用户空间</strong>：应用程序运行的内存区域，具有较低权限，只能访问受限的资源，如自己的内存、文件等，必须通过 <strong>系统调用（System Call）</strong> 请求内核资源。</li></ul><h4 id=地址空间划分以-32-位系统4gb-为例><strong>地址空间划分（以 32 位系统、4GB 为例）：</strong></h4><ul><li><strong>内核空间</strong>：0xC0000000 ~ 0xFFFFFFFF，约占 1GB，所有进程共享，用于存放内核代码、内核数据、设备驱动等。</li><li><strong>用户空间</strong>：0x00000000 ~ 0xBFFFFFFF，约占 3GB，每个进程独享，用于存放用户代码、用户数据、栈、堆等。</li></ul><h4 id=隔离性><strong>隔离性</strong></h4><ul><li><strong>安全性</strong>：防止用户程序误操作（如内存越界）导致系统崩溃。例如，用户态程序无法直接清空内存或配置硬件参数。</li><li><strong>稳定性</strong>：若用户程序崩溃（如空指针异常），仅影响自身用户空间，内核空间仍可正常运行，保障系统其他进程。</li><li><strong>资源管理</strong>：内核统一管理硬件资源（CPU、内存、I/O），避免用户程序直接竞争资源。</li></ul><h3 id=内核态和用户态>内核态和用户态</h3><ul><li><strong>内核态</strong>：操作系统内核运行的模式，具有最高权限，可直接访问硬件、内存管理、文件系统等底层资源。</li><li><strong>用户态</strong>：应用程序运行的模式，具有较低权限，只能访问受限的资源，如自己的内存、文件等，必须通过 <strong>系统调用（System Call）</strong> 请求内核资源。</li></ul><h4 id=如何切换><strong>如何切换？</strong></h4><div class=table-wrapper><table><thead><tr><th><strong>场景</strong></th><th>描述</th></tr></thead><tbody><tr><td><strong>系统调用</strong></td><td>用户程序主动请求内核服务（如<code>write()</code>），通过<code>int 0x80</code>指令触发切换。</td></tr><tr><td><strong>异常</strong></td><td>CPU执行用户程序时发生错误（如缺页异常），强制切换到内核态处理。</td></tr><tr><td><strong>硬件中断</strong></td><td>外设完成操作后（如磁盘I/O完成），中断信号触发切换。</td></tr></tbody></table></div><p><strong>用户态 → 内核态</strong>：</p><ul><li>执行特权指令（如<code>int 0x80</code>），CPU切换到Ring 0。</li><li>保存用户态现场（寄存器、用户栈指针）到内核栈。</li><li>执行内核代码（如系统调用处理程序）。</li></ul><p><strong>内核态 → 用户态</strong>：</p><ul><li>内核代码执行完毕（如文件写入完成）。</li><li>恢复用户态现场（从内核栈加载寄存器、用户栈指针）。</li><li>通过<code>sysret</code>指令切换回Ring 3，继续用户程序。</li></ul><blockquote><p><strong>示例</strong>：用户程序调用<code>write()</code>写入文件时：</p><ol><li>用户态程序通过库函数触发系统调用。</li><li>CPU切换到内核态，保存用户栈到内核栈。</li><li>内核执行文件写入，完成后恢复用户栈。</li><li>CPU切换回用户态，程序继续执行。</li></ol></blockquote><h3 id=微内核和宏内核>微内核和宏内核</h3><ul><li><strong>微内核（Micro Kernel）</strong>：<ul><li>一种精简的内核设计，仅包含操作系统最基本的核心功能，如进程管理、线程管理、IPC和基本的内存管理。</li><li>其他操作系统功能，如设备驱动、文件系统和网络协议等，则以用户态进程的形式运行。这种设计使得内核代码量小、结构清晰，便于扩展和维护，同时提高了系统的稳定性和安全性。</li></ul></li><li><strong>宏内核（Monolithic Kernel）</strong>：<ul><li>一种将大部分操作系统功能（如进程管理、内存管理、设备驱动、文件系统等）集成在一个大内核中的设计。</li><li>所有这些功能都运行在内核空间，通过函数调用直接交互。这种设计使得系统性能较高，因为减少了上下文切换和IPC的开销，但内核代码庞大且复杂，维护困难，且一个模块的崩溃可能导致整个系统崩溃。</li></ul></li></ul><p><strong>主要区别</strong>：</p><ol><li><strong>结构设计</strong>：<ul><li><strong>微内核</strong> 将大部分功能分离到用户空间，通过IPC通信；</li><li><strong>宏内核</strong> 将所有功能集成在内核空间，通过函数调用通信；</li></ul></li><li><strong>性能</strong>：<ul><li><strong>微内核</strong> 由于频繁的IPC和上下文切换，性能可能较低；</li><li><strong>宏内核</strong> 通常性能更高，因为减少了IPC开销；</li></ul></li><li><strong>稳定性和安全性</strong>：<ul><li><strong>微内核</strong> 由于内核代码少，攻击面小，且服务隔离，稳定性更高；</li><li><strong>宏内核</strong> 由于功能集中，一个模块的崩溃可能导致整个系统崩溃；</li></ul></li><li><strong>扩展性和维护</strong>：<ul><li><strong>微内核</strong> 的模块化设计便于扩展和维护；</li><li><strong>宏内核</strong> 由于代码复杂，维护和扩展较为困难。</li></ul></li></ol><p><strong>典型例子</strong>：</p><ul><li><strong>微内核</strong>：QNX、Minix、华为鸿蒙系统；</li><li><strong>宏内核</strong>：Linux、传统的Unix系统、Windows。</li></ul><h3 id=上下文切换>上下文切换</h3><p><strong>上下文切换</strong> 是操作系统在CPU核心上切换任务执行状态的过程，具体包括：</p><ol><li><strong>保存当前任务状态</strong>：用户态虚拟内存、寄存器、程序计数器、内核堆栈等。</li><li><strong>加载新任务状态</strong>：从内核的进程控制块（PCB）中恢复新任务的资源。</li><li><strong>触发条件</strong>：进程调度（时间片耗尽、I/O完成）、线程切换、中断响应等。</li></ol><p><strong>关键点</strong>：</p><ul><li>系统调用会触发两次上下文切换（用户态→内核态→用户态），但<strong>不涉及进程切换</strong>。</li><li>切换耗时：每次约几十纳秒到数微秒，高频切换会显著降低CPU利用率。</li></ul><div class=table-wrapper><table><thead><tr><th><strong>类型</strong></th><th><strong>触发场景</strong></th><th><strong>涉及资源</strong></th></tr></thead><tbody><tr><td><strong>进程切换</strong></td><td>多进程竞争CPU（时间片耗尽、进程终止、资源等待）</td><td>用户态虚拟内存、内核堆栈、寄存器、全局变量（需完全切换）</td></tr><tr><td><strong>线程切换</strong></td><td>多线程共享进程资源（同进程内线程切换更高效）</td><td>仅切换线程私有数据（寄存器、栈），共享进程虚拟内存和全局变量</td></tr><tr><td><strong>中断切换</strong></td><td>硬件中断（如I/O完成、定时器中断）触发内核中断服务程序（ISR）</td><td>仅内核态资源（寄存器、内核堆栈），不涉及用户态资源</td></tr></tbody></table></div><ul><li><strong>进程切换耗时更高</strong>：需刷新TLB（Translation Lookaside Buffer），导致内存访问延迟。</li><li><strong>线程切换更轻量</strong>：共享虚拟内存，无需刷新TLB，耗时约为进程切换的1/10。</li></ul><h3 id=dma>DMA</h3><p><strong>DMA（Direct Memory Access，直接内存访问）</strong> 是一种硬件机制，允许外设直接与计算机内存交换数据，<strong>不需要 CPU 介入每一步拷贝</strong>。它是现代计算机系统中提升效率、减少CPU占用率的核心技术。</p><p><strong>以从磁盘读取数据到内存为例</strong>：</p><ul><li><strong>传统数据传输</strong>：<ol><li>CPU发送读取命令；</li><li>磁盘将数据读取到设备侧的 <strong>内部缓冲区（Buffer）</strong> 中；</li><li>CPU 通过 <strong>轮询或中断</strong> 方式获取数据，<strong>逐字节或逐块</strong> 读取设备 Buffer 中的数据，再写入内存；</li><li>在数据传输期间，<strong>CPU 需持续参与搬运工作，无法执行其他任务</strong>，效率较低。</li></ol></li><li><strong>DMA 数据传输</strong>：<ol><li>CPU发送读取命令，并配置 DMA 控制器（源地址、目的地址、数据长度）；</li><li>磁盘将数据读取到设备缓冲区；</li><li>DMA控制器 <strong>自动将数据从设备 Buffer 直接写入内存</strong>，无需 CPU 参与；</li><li>传输完成后，DMA 发出 <strong>中断通知</strong> CPU，<strong>CPU 可在此期间处理其他任务</strong>，整体效率显著提升。</li></ol></li></ul><p><img src=/p/zero-copy/DMA.png width=1080 height=525 srcset="/p/zero-copy/DMA_hu_9dc8951193a0bfda.png 480w, /p/zero-copy/DMA_hu_be4799bd5e34cdde.png 1024w" loading=lazy alt=DMA class=gallery-image data-flex-grow=205 data-flex-basis=493px></p></section><footer class=article-footer><section class=article-tags><a href=/tags/i/o/>I/O</a>
<a href=/tags/%E9%9A%8F%E8%AE%B0/>随记</a>
<a href=/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/>操作系统</a>
<a href=/tags/linux/>Linux</a>
<a href=/tags/%E9%9B%B6%E6%8B%B7%E8%B4%9D/>零拷贝</a>
<a href=/tags/%E7%94%A8%E6%88%B7%E7%A9%BA%E9%97%B4/>用户空间</a>
<a href=/tags/%E5%86%85%E6%A0%B8%E7%A9%BA%E9%97%B4/>内核空间</a>
<a href=/tags/%E5%BE%AE%E5%86%85%E6%A0%B8/>微内核</a>
<a href=/tags/%E5%AE%8F%E5%86%85%E6%A0%B8/>宏内核</a></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{const e=document.querySelector(".main-article");renderMathInElement(e,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><aside class=related-content--wrapper><h2 class=section-title>相关文章</h2><div class=related-content><div class="flex article-list--tile"><article class=has-image><a href=/p/io/><div class=article-image><img src=/p/io/io.6e22b7ab0f0dd2388a23186be7b7e919_hu_60e2856ab9152075.png width=250 height=150 loading=lazy alt="Featured image of post I/O" data-key=io data-hash="md5-biK3qw8N0jiKIxhr57fpGQ=="></div><div class=article-details><h2 class=article-title>I/O</h2></div></a></article><article class=has-image><a href=/p/process-thread/><div class=article-image><img src=/p/process-thread/process-thread.951d5fd5ead489ab09fb78dce19f3081_hu_166712da914cf4c1.webp width=250 height=150 loading=lazy alt="Featured image of post 进程与线程" data-key=process-thread data-hash="md5-lR1f1erUiasJ+3jc4Z8wgQ=="></div><div class=article-details><h2 class=article-title>进程与线程</h2></div></a></article><article class=has-image><a href=/p/first-principle/><div class=article-image><img src=/p/first-principle/%E7%AC%AC%E4%B8%80%E6%80%A7%E5%8E%9F%E7%90%86.344956004994ebcf1b12745a720b358b_hu_c12108cc1a1311.webp width=250 height=150 loading=lazy alt="Featured image of post 第一性原理" data-key=first-principle data-hash="md5-NElWAEmU688bEnRacgs1iw=="></div><div class=article-details><h2 class=article-title>第一性原理</h2></div></a></article><article class=has-image><a href=/p/kiss-principle/><div class=article-image><img src=/p/kiss-principle/kiss.10862f53dbcc21fe79005d59fb7c0406_hu_8e562e59d83ef830.webp width=250 height=150 loading=lazy alt="Featured image of post KISS原则" data-key=kiss-principle data-hash="md5-EIYvU9vMIf55AF1Z+3wEBg=="></div><div class=article-details><h2 class=article-title>KISS原则</h2></div></a></article><article class=has-image><a href=/p/performance-optimization/><div class=article-image><img src=/p/performance-optimization/%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96.407ef1856db87e08496b3a2a10de7533_hu_d5dc9ab0b5b7ddcf.webp width=250 height=150 loading=lazy alt="Featured image of post 性能优化：从数据出发，基于实际需求" data-key=performance-optimization data-hash="md5-QH7xhW24fghJazoqEN51Mw=="></div><div class=article-details><h2 class=article-title>性能优化：从数据出发，基于实际需求</h2></div></a></article></div></div></aside><footer class=site-footer><section class=copyright>&copy;
2023 -
2025 Yellster - Blog</section><section class=powerby>想都是问题，做才是答案！<br>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.30.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>